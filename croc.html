<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lochys Whack-a-Croc Challenge</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Load Tone.js for audio -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.js"></script>
    <style>
        /* Custom styles for the game board and crocs */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #0d1117; /* Dark background */
        }
        .hole-container {
            width: 100%;
            height: 100%;
            overflow: hidden; /* Important to hide the croc when it's down */
            border-radius: 50%; /* Ensures the 'hole' is perfectly round */
            position: relative;
            background-color: #283747; /* Soil color */
            border: 4px solid #1c2531;
            box-shadow: inset 0 8px 10px rgba(0, 0, 0, 0.4);
            cursor: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 32 32"><path fill="%23FFFFFF" stroke="%23000000" stroke-width="2" d="M16 0L24 8L16 32L8 8Z"/></svg>'), auto; /* Custom mallet cursor */
        }
        .croc {
            position: absolute;
            bottom: -150%; /* Start hidden way below the hole */
            width: 100%;
            transition: bottom 0.05s cubic-bezier(0.1, 0.9, 0.2, 1); /* Faster, snappier transition */
            cursor: pointer;
            pointer-events: none; /* Initially unhittable until it pops */
            z-index: 10;
        }
        .croc.up {
            bottom: -25%; /* Pop up higher to show more of the face */
            pointer-events: all;
        }

        /* SVG styles for the croc face */
        .croc-face {
            fill: #4CAF50; /* Croc green */
            stroke: #2E7D32;
            stroke-width: 2px;
            filter: drop-shadow(0 4px 6px rgba(0,0,0,0.5));
        }
        .croc-eyes {
            fill: #FFFFFF;
            stroke: #000000;
            stroke-width: 1px;
        }
        .croc-pupils {
            fill: #000000;
        }

        /* Message box style */
        #message-box {
            position: fixed;
            top: 1rem;
            right: 1rem;
            z-index: 50;
            opacity: 0;
            transition: opacity 0.5s ease-in-out;
        }
        #message-box.show {
            opacity: 1;
        }
    </style>
</head>
<body class="min-h-screen flex items-center justify-center p-4">

    <!-- Game Container -->
    <div id="game-container" class="w-full max-w-4xl bg-[#1e293b] p-6 sm:p-10 rounded-xl shadow-2xl border-2 border-gray-700">
        <h1 class="text-4xl sm:text-5xl font-extrabold text-green-400 text-center mb-6 tracking-tight">
            Lochys Whack-a-Croc Challenge üêä
        </h1>

        <!-- Scoreboard & Controls -->
        <div class="flex flex-col sm:flex-row justify-between items-center bg-[#0f172a] p-4 rounded-lg mb-8 shadow-inner border border-gray-600">
            <div class="text-lg font-semibold text-gray-200">
                Score: <span id="score" class="text-yellow-400 text-2xl ml-2">0</span>
            </div>
            <div class="text-lg font-semibold text-gray-200 mt-2 sm:mt-0">
                High Score: <span id="high-score" class="text-pink-400 text-2xl ml-2">0</span>
            </div>
            <!-- REMOVED inline onclick, using addEventListener in script instead -->
            <button id="start-button" class="mt-4 sm:mt-0 px-6 py-3 bg-red-600 text-white font-bold text-xl rounded-lg shadow-lg hover:bg-red-700 transition duration-150 transform hover:scale-105">
                Start Game
            </button>
        </div>

        <!-- Game Board (The Grid) -->
        <div id="game-board" class="grid grid-cols-3 gap-4 sm:gap-6 lg:gap-8 aspect-square max-w-lg mx-auto">
            <!-- Croc Holes will be injected here -->
        </div>

        <!-- Status/Error Message Box -->
        <div id="message-box" class="p-3 bg-yellow-500 text-gray-900 rounded-lg shadow-xl font-semibold">
            Game Messages Here
        </div>
    </div>

    <!-- Firebase SDK Imports -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, setPersistence, browserSessionPersistence } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Global Game Variables
        let score = 0;
        let highScore = 0;
        let gameInterval;
        let gameActive = false;
        const gameDuration = 30000; // 30 seconds
        const popupSpeed = 1000; // Croc appears/hides every 1000ms (Slower Pace)
        const numHoles = 9;
        const crocs = []; // Array to hold croc elements

        // Firebase Setup
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let app, db, auth, userId;
        let isAuthReady = false;

        // --- Tone.js Audio Setup ---
        
        // 1. Hit Sound (Sharp percussion)
        const hitSynth = new Tone.MembraneSynth({
            pitchDecay: 0.03,
            octaves: 0.5,
            envelope: { attack: 0.001, decay: 0.1, sustain: 0.0, release: 0.01 }
        }).toDestination();

        // 2. Miss Sound (Low, negative buzz)
        const missSynth = new Tone.NoiseSynth({
            volume: -10, // FIX: Setting volume correctly in the constructor
            noise: { type: 'pink' },
            envelope: { attack: 0.005, decay: 0.1, sustain: 0, release: 0.1 }
        }).toDestination();
        
        // 3. Chip Music (Background song)
        const chipSynth = new Tone.PolySynth(Tone.DuoSynth).toDestination();
        chipSynth.set({
            voice0: {
                oscillator: { type: "square" }, // Classic chip sound
                envelope: { attack: 0.02, decay: 0.1, sustain: 0.2, release: 0.8 }
            },
            voice1: {
                oscillator: { type: "triangle" },
                envelope: { attack: 0.05, decay: 0.1, sustain: 0.2, release: 0.8 }
            }
        });
        chipSynth.volume.value = -18; // Keep it low volume for background

        const melody = [
            ["C5", "E5", "G5"], null,
            ["G4", "B4", "D5"], null,
            ["A4", "C5", "E5"], null,
            ["F4", "A4", "C5"], null
        ];

        const bassline = ["C3", null, "G2", null, "A2", null, "F2", null];

        const mainSequence = new Tone.Sequence((time, chord) => {
            if (chord) {
                chipSynth.triggerAttackRelease(chord, "8n", time);
            }
        }, melody, "4n");

        const bassSequence = new Tone.Sequence((time, note) => {
            if (note) {
                chipSynth.triggerAttackRelease(note, "4n", time);
            }
        }, bassline, "4n");

        Tone.Transport.bpm.value = 140; // Fun tempo
        Tone.Transport.loop = true;
        Tone.Transport.loopEnd = "2m"; // Long enough loop end

        // --- Audio Control Functions ---

        function playHitSound() {
            hitSynth.triggerAttackRelease("C4", "32n");
        }

        function playMissSound() {
            missSynth.triggerAttackRelease("16n");
        }

        function startMusic() {
            // Start the Tone Transport (which handles all sequences)
            Tone.Transport.start();
            mainSequence.start(0);
            bassSequence.start(0);
        }
        
        function stopMusic() {
            mainSequence.stop();
            bassSequence.stop();
            Tone.Transport.stop();
        }

        // Listener to start the game and initialize audio context
        document.getElementById('start-button').addEventListener('click', async () => {
            if (Tone.context.state !== 'running') {
                try {
                    await Tone.start();
                    showMessage("Audio enabled!", "bg-blue-500");
                } catch(e) {
                    console.error("Failed to start Tone.js AudioContext:", e);
                    showMessage("Audio failed to start. Check console.", "bg-red-500");
                }
            }
            startGame(); // Call the globally defined game function
        });


        function showMessage(msg, style = "bg-green-500", duration = 3000) {
            const msgBox = document.getElementById('message-box');
            msgBox.textContent = msg;
            msgBox.className = `${style} text-gray-900 p-3 rounded-lg shadow-xl font-semibold show`;
            
            clearTimeout(msgBox.dataset.timer);
            msgBox.dataset.timer = setTimeout(() => {
                msgBox.classList.remove('show');
            }, duration);
        }

        // --- Firestore Functions (Unchanged) ---

        function getHighScoreDocRef() {
            if (!db || !userId) return null;
            const collectionPath = `/artifacts/${appId}/users/${userId}/whack_a_croc_scores`;
            return doc(db, collectionPath, 'highScore');
        }

        async function fetchHighScore() {
            const docRef = getHighScoreDocRef();
            if (!docRef) {
                console.error("Firestore not ready to fetch high score.");
                return;
            }
            try {
                const docSnap = await getDoc(docRef);
                if (docSnap.exists()) {
                    highScore = docSnap.data().score || 0;
                    document.getElementById('high-score').textContent = highScore;
                }
            } catch (error) {
                console.error("Error fetching high score:", error);
            }
        }

        async function updateHighScore(newScore) {
            if (newScore > highScore) {
                highScore = newScore;
                document.getElementById('high-score').textContent = highScore;
                const docRef = getHighScoreDocRef();
                if (docRef) {
                    try {
                        await setDoc(docRef, { score: newScore, userId: userId, updated: new Date().toISOString() });
                        showMessage("NEW High Score Saved!", "bg-pink-600");
                    } catch (error) {
                        console.error("Error saving high score:", error);
                        showMessage("Failed to save high score.", "bg-red-600");
                    }
                }
            }
        }

        // --- Game Logic ---

        function updateScore(points) {
            score += points;
            document.getElementById('score').textContent = score;
        }

        // The SVG for the Croc head (Improved graphics for visibility)
        const crocSVG = `
            <svg viewBox="0 0 100 100" class="w-full h-full" preserveAspectRatio="xMidYMax meet">
                <!-- Snout/Head Shape (more croc-like path) -->
                <path class="croc-face" d="M 10 95 L 90 95 Q 95 65, 80 35 C 70 15, 30 15, 20 35 Q 5 65, 10 95 Z" />

                <!-- Upper Jaw Bumps (snout texture) -->
                <rect x="20" y="50" width="60" height="8" rx="4" ry="4" class="croc-face" style="fill: #2E7D32;"/>

                <!-- Eyes Bumps -->
                <circle cx="30" cy="25" r="10" class="croc-face" style="transform-origin: center; transform: scaleY(0.7);"/>
                <circle cx="70" cy="25" r="10" class="croc-face" style="transform-origin: center; transform: scaleY(0.7);"/>

                <!-- Eyes -->
                <circle cx="30" cy="25" r="3" class="croc-pupils" />
                <circle cx="70" cy="25" r="3" class="croc-pupils" />
            </svg>
        `;

        function setupGameBoard() {
            const board = document.getElementById('game-board');
            board.innerHTML = ''; // Clear previous board
            crocs.length = 0; // Reset croc array

            for (let i = 0; i < numHoles; i++) {
                const hole = document.createElement('div');
                hole.className = 'hole-container';
                
                const croc = document.createElement('div');
                croc.className = 'croc';
                croc.innerHTML = crocSVG;
                croc.dataset.index = i;
                croc.addEventListener('click', () => whackCroc(i));
                
                hole.appendChild(croc);
                board.appendChild(hole);
                crocs.push(croc);
            }
        }

        function whackCroc(index) {
            if (!gameActive) return;
            const crocElement = crocs[index];
            if (crocElement.classList.contains('up')) {
                // SUCCESSFUL HIT: Instant feedback and reset
                updateScore(100);
                playHitSound();

                // Instantly hide the croc
                crocElement.classList.remove('up');
                crocElement.style.pointerEvents = 'none'; // Prevent double-clicks
                
                // Visual feedback for hit (quick flash)
                crocElement.parentElement.classList.add('ring-4', 'ring-green-400/70', 'ring-opacity-75');
                setTimeout(() => {
                    crocElement.parentElement.classList.remove('ring-4', 'ring-green-400/70', 'ring-opacity-75');
                }, 100);

            } else {
                // MISSED CROC / HIT HOLE: Play miss sound
                playMissSound(); 
                showMessage("Miss! Hit the hole!", "bg-yellow-500", 1500);
            }
        }

        function popRandomCroc() {
            if (!gameActive) return;

            // 1. Hide any currently visible crocs (if any were missed)
            crocs.forEach(c => {
                if (c.classList.contains('up')) {
                    // Missed croc: Play miss sound and show penalty visual
                    playMissSound(); 
                    c.parentElement.classList.add('ring-4', 'ring-red-500/70', 'ring-opacity-75');
                    setTimeout(() => {
                        c.parentElement.classList.remove('ring-4', 'ring-red-500/70', 'ring-opacity-75');
                    }, 100);
                }
                c.classList.remove('up');
                c.style.pointerEvents = 'none';
            });

            // 2. Select a new random hole
            const randomIndex = Math.floor(Math.random() * numHoles);
            const nextCroc = crocs[randomIndex];

            // 3. Make the new croc appear quickly
            nextCroc.classList.add('up');
            nextCroc.style.pointerEvents = 'all';

            // 4. Set the next pop-up time
            gameInterval = setTimeout(popRandomCroc, popupSpeed);
        }

        // Exposed globally for access via addEventListener
        window.startGame = function() {
            if (!isAuthReady) {
                showMessage("Initializing Firebase... please wait a moment.", "bg-yellow-500");
                return;
            }

            if (gameActive) return;

            score = 0;
            updateScore(0);
            gameActive = true;
            document.getElementById('start-button').textContent = "Game In Progress...";
            document.getElementById('start-button').disabled = true;
            
            startMusic(); // START THE CHIP MUSIC
            
            // Start the pop-up loop
            popRandomCroc();

            // End the game after duration
            setTimeout(() => {
                endGame();
            }, gameDuration);

            showMessage("GO! Whack the Crocs!", "bg-green-500");
        }

        function endGame() {
            gameActive = false;
            clearTimeout(gameInterval);
            
            stopMusic(); // STOP THE CHIP MUSIC
            
            // Hide all remaining crocs
            crocs.forEach(c => c.classList.remove('up'));

            document.getElementById('start-button').textContent = "Start New Game";
            document.getElementById('start-button').disabled = false;
            
            showMessage(`Time's Up! Final Score: ${score}`, "bg-blue-600", 5000);
            updateHighScore(score);
        }

        // --- Initialization ---

        async function initFirebase() {
            if (!firebaseConfig || Object.keys(firebaseConfig).length === 0) {
                 console.error("Firebase config is missing or empty.");
                 showMessage("Firebase config missing. High score won't be saved.", "bg-red-500");
                 isAuthReady = true; // Still allow game to run
                 return;
            }
            try {
                setLogLevel('error'); // Only log errors to console
                app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);

                // Set session persistence
                await setPersistence(auth, browserSessionPersistence);

                // Sign in logic
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }

                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        userId = user.uid;
                        isAuthReady = true;
                        document.getElementById('message-box').dataset.userId = userId; // For debugging
                        await fetchHighScore();
                        showMessage(`Signed in (User ID: ${userId.substring(0, 8)}...).`, "bg-teal-500");
                    } else {
                        // This should not happen if signInAnonymously succeeds
                        console.error("User not authenticated after sign-in attempt.");
                        isAuthReady = true;
                    }
                });

            } catch (error) {
                console.error("Firebase initialization or sign-in failed:", error);
                showMessage("Auth Error. Game can run but scores won't save.", "bg-red-500");
                isAuthReady = true; // Allow game to proceed without score saving
            }
        }

        window.onload = function() {
            setupGameBoard();
            initFirebase();
        }

    </script>
</body>
</html>